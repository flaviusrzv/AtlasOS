name: Sync Fork with Atlas-OS New Update

on:
  # Permite declanÈ™area manualÄƒ
  workflow_dispatch:
  # RuleazÄƒ automat o datÄƒ pe zi la miezul nopÈ›ii UTC
  schedule:
    - cron: '0 0 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout fork
      uses: actions/checkout@v4
      with:
        # CheckoutÄƒm branch-ul main din fork
        ref: main
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Git
      run: |
        # Configurare Git cu identitatea GitHub Action
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        
        # AfiÈ™are informaÈ›ii despre repository pentru debugging
        echo "ğŸ” Repository curent: $(git remote -v)"
        echo "ğŸ” Branch curent: $(git branch --show-current)"

    - name: Add upstream remote
      run: |
        echo "ğŸ”„ AdÄƒugare È™i actualizare remote upstream..."
        # AdaugÄƒ remote sau ignorÄƒ dacÄƒ existÄƒ deja
        git remote add upstream https://github.com/Atlas-OS/Atlas.git || echo "Upstream existÄƒ deja"
        
        # Fetch pentru a obÈ›ine toate branch-urile din upstream
        git fetch upstream
        echo "âœ… Upstream fetchat cu succes"
        
        # AfiÈ™Äƒm branch-urile disponibile Ã®n upstream
        echo "Branch-uri disponibile Ã®n upstream:"
        git ls-remote --heads upstream

    - name: Merge changes from upstream new-update branch
      run: |
        echo "ğŸ”„ Sincronizare branch main cu upstream/new-update..."
        
        # Strategia 1: ÃncercÄƒm un merge simplu
        if git merge upstream/new-update; then
          echo "âœ… Merge reuÈ™it!"
        else
          # AnulÄƒm merge-ul eÈ™uat
          git merge --abort
          
          # Strategia 2: ÃncercÄƒm merge cu -X ours (pÄƒstreazÄƒ modificÄƒrile noastre Ã®n caz de conflict)
          echo "âš ï¸ Merge simplu eÈ™uat, Ã®ncercÄƒm cu strategia -X ours..."
          if git merge -X ours upstream/new-update; then
            echo "âœ… Merge cu -X ours reuÈ™it!"
          else
            # AnulÄƒm merge-ul eÈ™uat din nou
            git merge --abort
            
            # Strategia 3: ResetÄƒm main la starea upstream/new-update
            echo "âš ï¸ ÃncercÄƒm resetarea completÄƒ la upstream/new-update..."
            git reset --hard upstream/new-update
            echo "âœ… Reset la upstream/new-update reuÈ™it!"
          fi
        fi

    - name: Push changes
      run: |
        echo "ğŸš€ Push schimbÄƒri cÄƒtre origin/main..."
        # Folosim -f pentru a forÈ›a push-ul Ã®n caz cÄƒ istoricul a fost rescris
        git push -f origin main || echo "âš ï¸ Push eÈ™uat, verificaÈ›i permisiunile repository-ului"
        echo "âœ… Sincronizare completÄƒ Ã®ntre upstream/new-update È™i fork/main!"
